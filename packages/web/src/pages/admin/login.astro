---
/**
 * Admin Login Page
 */
import Layout from '@/layouts/base.astro'
import { getSessionIdFromCookies, validateSession } from '@/lib/auth'

// Check if already logged in
const sessionId = getSessionIdFromCookies(Astro.request.headers.get('cookie'))

if (validateSession(sessionId)) {
  return Astro.redirect('/admin')
}
---

<Layout title="Admin Login">
  <div
    class="flex min-h-screen items-center justify-center bg-gradient-to-b from-green-50 to-white px-4"
  >
    <div class="w-full max-w-md">
      <div class="rounded-xl border bg-white p-8 shadow-sm">
        <div class="mb-8 text-center">
          <h1 class="text-2xl font-bold text-green-700">Admin Login</h1>
          <p class="mt-2 text-sm text-gray-600">Biodiversidade.Online</p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label
              for="pin"
              class="mb-2 block text-sm font-medium text-gray-700"
            >
              PIN de Acesso
            </label>
            <input
              type="password"
              id="pin"
              name="pin"
              required
              autocomplete="current-password"
              placeholder="Digite o PIN de acesso"
              class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-green-500 focus:ring-green-500"
            />
          </div>

          <div
            id="errorMessage"
            class="hidden text-center text-sm text-red-600"
          >
          </div>

          <button
            type="submit"
            class="w-full rounded-md bg-green-600 px-4 py-2 font-medium text-white transition-colors hover:bg-green-700"
          >
            Entrar
          </button>
        </form>

        <div class="mt-6 text-center">
          <a href="/" class="text-sm text-gray-500 hover:text-green-600">
            &larr; Voltar ao Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('loginForm') as HTMLFormElement
  const errorMessage = document.getElementById('errorMessage') as HTMLDivElement

  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const pin = (document.getElementById('pin') as HTMLInputElement).value

    errorMessage.classList.add('hidden')

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin })
      })

      const data = await response.json()

      if (response.ok) {
        window.location.href = '/admin'
      } else {
        errorMessage.textContent = data.error || 'Erro ao fazer login'
        errorMessage.classList.remove('hidden')
      }
    } catch (error) {
      errorMessage.textContent = 'Erro de conex√£o'
      errorMessage.classList.remove('hidden')
    }
  })
</script>
